<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.www.ledger.data.mapper.OrderInfoMapper">
    <resultMap id="BaseResultMap" type="com.www.ledger.data.entity.OrderInfoEntity">
        <!--@Table ORDER_INFO-->
        <id column="OI_ID" property="oiId" />
        <result column="ORDER_ID" property="orderId" />
        <result column="SHOP_ID" property="shopId" />
        <result column="USER_ID" property="userId" />
        <result column="ORDER_DATE" property="orderDate" />
        <result column="SUPPLY_ID" property="supplyId" />
        <result column="GOODS_ID" property="goodsId" />
        <result column="GOODS_NAME" property="goodsName" />
        <result column="ORDER_STATE" property="orderState" />
        <result column="SALE_AMOUNT" property="saleAmount" />
        <result column="PAYMENT_AMOUNT" property="paymentAmount" />
        <result column="COST_AMOUNT" property="costAmount" />
        <result column="PAYOUT_AMOUNT" property="payoutAmount" />
        <result column="TOTAL_COST" property="totalCost" />
        <result column="GROSS_PROFIT" property="grossProfit" />
        <result column="GROSS_PROFIT_RATE" property="grossProfitRate" />
        <result column="REMARK" property="remark" />
        <result column="UPDATE_TIME" property="updateTime" />
        <result column="CREATE_TIME" property="createTime" />
    </resultMap>
    <!--  统计月销售额-->
    <select id="countMonthSale" resultType="com.www.ledger.data.dto.MonthDTO">
        SELECT D.SHOP_ID shopId,
               S.SHOP_NAME shopName,
               D.MONTH monthDateStr,
               COUNT(D.OI_ID) totalOrder,
               COUNT(IF((D.ORDER_STATE = '3' OR D.ORDER_STATE = '4'), D.OI_ID,NULL)) succeedOrder,
               SUM(IF((D.ORDER_STATE = '3' OR D.ORDER_STATE = '4'), D.PAYMENT_AMOUNT,0)) saleAmount,
               SUM(IF((D.ORDER_STATE = '3' OR D.ORDER_STATE = '4'), D.TOTAL_COST,0)) costAmount,
               SUM(IF(D.ORDER_STATE = '7', D.TOTAL_COST,0)) virtualAmount
        FROM( SELECT C.OI_ID,
                     C.ORDER_ID,
                     C.SHOP_ID,
                     CONCAT(DATE_FORMAT(C.ORDER_DATE,'%Y-%m'),'-01') MONTH,
                     C.ORDER_STATE,
                     C.PAYMENT_AMOUNT,
                     C.TOTAL_COST
              FROM  ORDER_INFO C WHERE C.USER_ID = #{userId}) D,USER_SHOP S
        WHERE S.SHOP_ID = D.SHOP_ID AND S.SHOP_STATE='1'
        GROUP BY D.MONTH,D.SHOP_ID
    </select>
    <!--  查询订单信息-->
    <select id="findOrdeList" resultType="com.www.ledger.data.dto.OrderDTO">
        SELECT O.OI_ID oiId,
        O.ORDER_ID orderId,
        O.SHOP_ID shopId,
        S.SHOP_NAME shopName,
        DATE_FORMAT(O.ORDER_DATE,'%Y-%m-%d') orderDateStr,
        O.SUPPLY_ID supplyId,
        O.GOODS_ID goodsId,
        O.GOODS_NAME goodsName,
        G.GOODS_URL goodsUrl,
        O.ORDER_STATE orderState,
        O.SALE_AMOUNT saleAmount,
        O.PAYMENT_AMOUNT paymentAmount,
        O.COST_AMOUNT costAmount,
        O.PAYOUT_AMOUNT payoutAmount,
        O.TOTAL_COST totalCost,
        O.GROSS_PROFIT grossProfit,
        O.GROSS_PROFIT_RATE grossProfitRate,
        O.REMARK remark
        FROM USER_SHOP S,ORDER_INFO O
        LEFT JOIN SHOP_GOODS G ON G.GOODS_ID = O.GOODS_ID AND G.SHOP_ID = O.SHOP_ID
        WHERE O.SHOP_ID = S.SHOP_ID AND S.SHOP_STATE='1'
            AND O.USER_ID = #{obj.userId} AND S.USER_ID = #{obj.userId}
        <if test="obj.orderDateStr != null and obj.orderDateStr != ''">
            AND O.ORDER_DATE = STR_TO_DATE(#{obj.orderDateStr},'%Y-%m-%d')
        </if>
        <if test="obj.orderId != null and obj.orderId != ''">
            AND O.ORDER_ID = #{obj.orderId}
        </if>
        <if test="obj.shopId != null and obj.shopId != ''">
            AND O.SHOP_ID = #{obj.shopId}
        </if>
        <if test="obj.supplyId != null and obj.supplyId != ''">
            AND O.SUPPLY_ID = #{obj.supplyId}
        </if>
        <if test="obj.goodsId != null and obj.goodsId != ''">
            AND O.GOODS_ID = #{obj.goodsId}
        </if>
        <if test="obj.orderState != null and obj.orderState != ''">
            AND O.ORDER_STATE = #{obj.orderState}
        </if>
        ORDER BY O.ORDER_DATE DESC,O.ORDER_ID DESC
    </select>
</mapper>